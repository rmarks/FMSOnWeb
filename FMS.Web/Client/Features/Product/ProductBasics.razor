@inject HttpClient Http

@if (_dropdowns is null)
{
    <p>Loading...</p>
}
else
{
    <EditForm Model="@_productBase" OnValidSubmit="SubmitForm">
        <FluentValidationValidator />
        <div class="row mb-3">
            <div class="col-auto">
                <div class="card" style="width: 268px;">
                    <img class="card-img" src="@_imagePath">
                </div>
            </div>

            <div class="col">
                <FormSection>
                    <FormFieldSet Width="col-2">
                        <label class="font-weight-bold text-secondary">Kood</label>
                        <InputText class="form-control" @bind-Value="@_productBase.Code" />
                        <ValidationMessage For="@(() => _productBase.Code)" />
                    </FormFieldSet>
                    <FormFieldSet Width="col-4">
                        <label class="font-weight-bold text-secondary">Nimi</label>
                        <InputText class="form-control" @bind-Value="@_productBase.Name" />
                        <ValidationMessage For="@(() => _productBase.Name)" />
                    </FormFieldSet>
                </FormSection>
            </div>
        </div>

        <div class="row">
            <div class="col-3">
                <FormSection>
                    <FormFieldSet>
                        <label class="font-weight-bold text-secondary">Olek</label>
                        <InputSelect class="form-control" @bind-Value="@_productBase.ProductStatusId">
                            <option value="">-- Vali ---</option>
                            @foreach (var item in _dropdowns.ProductStatuses)
                                {
                                <option value="@item.Id">@item.Name</option>
                                }
                        </InputSelect>
                        <ValidationMessage For="@(() => _productBase.ProductStatusId)" />
                    </FormFieldSet>
                    <FormFieldSet>
                        <label class="font-weight-bold text-secondary">Lähtetüüp</label>
                        <InputSelect class="form-control" @bind-Value="@_productBase.ProductSourceTypeId">
                            <option value="">-- Vali ---</option>
                            @foreach (var item in _dropdowns.ProductSourceTypes)
                                {
                                <option value="@item.Id">@item.Name</option>
                                }
                        </InputSelect>
                        <ValidationMessage For="@(() => _productBase.ProductSourceTypeId)" />
                    </FormFieldSet>
                    <FormFieldSet>
                        <label class="font-weight-bold text-secondary">Sihttüüp</label>
                        <InputSelect class="form-control" @bind-Value="@_productBase.ProductDestinationTypeId">
                            <option value="">-- Vali ---</option>
                            @foreach (var item in _dropdowns.ProductDestinationTypes)
                                {
                                <option value="@item.Id">@item.Name</option>
                                }
                        </InputSelect>
                        <ValidationMessage For="@(() => _productBase.ProductDestinationTypeId)" />
                    </FormFieldSet>
                    <FormFieldSet>
                        <label class="font-weight-bold text-secondary">Materjal</label>
                        <InputSelect class="form-control" @bind-Value="@_productBase.ProductMaterialId">
                            <option value="">-- Vali ---</option>
                            @foreach (var item in _dropdowns.ProductMaterials)
                                {
                                <option value="@item.Id">@item.Name</option>
                                }
                        </InputSelect>
                        <ValidationMessage For="@(() => _productBase.ProductMaterialId)" />
                    </FormFieldSet>
                </FormSection>
            </div>

            <div class="col-3">
                <FormSection>
                    <FormFieldSet>
                        <label class="font-weight-bold text-secondary">Tüüp</label>
                        <InputSelect class="form-control" @bind-Value="@_productBase.ProductTypeId">
                            <option value="">-- Vali ---</option>
                            @foreach (var item in _dropdowns.ProductTypes)
                            {
                                <option value="@item.Id">@item.Name</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => _productBase.ProductTypeId)" />
                    </FormFieldSet>
                    <FormFieldSet>
                        <label class="font-weight-bold text-secondary">Grupp</label>
                        <InputSelect class="form-control" @bind-Value="@_productBase.ProductGroupId">
                            <option value="">-- Vali ---</option>
                            @foreach (var item in _dropdowns.GetFilteredProductGroups(_productBase.ProductTypeId))
                                {
                                <option value="@item.Id">@item.Name</option>
                                }
                        </InputSelect>
                        <ValidationMessage For="@(() => _productBase.ProductGroupId)" />
                    </FormFieldSet>
                    <FormFieldSet>
                        <label class="font-weight-bold text-secondary">Kaubamärk</label>
                        <InputSelect class="form-control" @bind-Value="@_productBase.ProductBrandId">
                            <option value="">-- Vali ---</option>
                            @foreach (var item in _dropdowns.ProductBrands)
                                {
                                <option value="@item.Id">@item.Name</option>
                                }
                        </InputSelect>
                    </FormFieldSet>
                    <FormFieldSet>
                        <label class="font-weight-bold text-secondary">Kollektsioon</label>
                        <InputSelect class="form-control" @bind-Value="@_productBase.ProductCollectionId">
                            <option value="">-- Vali ---</option>
                            @foreach (var item in _dropdowns.GetFilteredProductCollections(_productBase.ProductBrandId))
                                {
                                <option value="@item.Id">@item.Name</option>
                                }
                        </InputSelect>
                    </FormFieldSet>
                </FormSection>
            </div>

            <div class="col">
                <FormSection>
                    <label class="font-weight-bold text-secondary">Kommentaarid</label>
                    <InputTextArea class="form-control" @bind-Value="@_productBase.Comments" rows="12" />
                </FormSection>
            </div>
        </div>

        <div class="mt-4 pt-2 border-top">
            <div class="row">
                <div class="offset-4 col-8 text-right">
                    <button class="btn btn-outline-secondary" type="button" disabled>Loobu</button>
                    <button class="btn btn-primary" type="submit" disabled>Salvesta</button>
                </div>
            </div>
        </div>
    </EditForm>
}

@code {
    private ProductBasicsDto _productBase = new ProductBasicsDto();
    //private EditContext _editContext;
    private ProductBasicsDropdowns _dropdowns;
    private string _imagePath = "img/products/BlankImage.png";

    [Parameter] public int Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        //_editContext = new EditContext(_productBase);
        //_editContext.OnFieldChanged += (sender, e) => _editContext.Validate();

        if (Id > 0)
        {
            _productBase = await Http.GetFromJsonAsync<ProductBasicsDto>($"api/productbasics/{Id}");
            _imagePath = $"img/products/{_productBase.Code}.jpg";
        }

        _dropdowns = await Http.GetFromJsonAsync<ProductBasicsDropdowns>("api/productbasics/dropdowns");
    }

    private void SubmitForm()
    {

    }
}
